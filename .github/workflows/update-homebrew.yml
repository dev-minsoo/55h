name: Update Homebrew Tap

on:
  release:
    types: [published]

env:
  TAP_REPO: dev-minsoo/homebrew-tap
  FORMULA_PATH: Formula/55h.rb
  BINARY_NAME: 55h

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read release metadata
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${GITHUB_REF_NAME}"
          DATA=$(curl -sSL -H "Authorization: Bearer ${GITHUB_TOKEN}" "$API_URL")
          TAG=$(echo "$DATA" | jq -r '.tag_name')
          VERSION=${TAG#v}
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          ARM_NAME="${BINARY_NAME}_${TAG}_darwin_arm64.tar.gz"
          AMD_NAME="${BINARY_NAME}_${TAG}_darwin_amd64.tar.gz"

          ARM_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${ARM_NAME}"
          AMD_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${AMD_NAME}"

          echo "arm_name=$ARM_NAME" >> "$GITHUB_OUTPUT"
          echo "amd_name=$AMD_NAME" >> "$GITHUB_OUTPUT"
          echo "arm_url=$ARM_URL" >> "$GITHUB_OUTPUT"
          echo "amd_url=$AMD_URL" >> "$GITHUB_OUTPUT"

      - name: Download release assets
        run: |
          set -euo pipefail
          curl -sSL -o arm.tar.gz "${{ steps.release.outputs.arm_url }}"
          curl -sSL -o amd.tar.gz "${{ steps.release.outputs.amd_url }}"

      - name: Compute sha256
        id: sha
        run: |
          set -euo pipefail
          ARM_SHA=$(shasum -a 256 arm.tar.gz | awk '{print $1}')
          AMD_SHA=$(shasum -a 256 amd.tar.gz | awk '{print $1}')
          echo "arm_sha=$ARM_SHA" >> "$GITHUB_OUTPUT"
          echo "amd_sha=$AMD_SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update Formula
        working-directory: tap
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "${FORMULA_PATH}")"
          cat > "${FORMULA_PATH}" <<'RUBY'
          class FiftyFiveH < Formula
            desc "55h"
            homepage "https://github.com/dev-minsoo/55h"
            version "${{ steps.release.outputs.version }}"

            on_macos do
              if Hardware::CPU.arm?
                url "${{ steps.release.outputs.arm_url }}"
                sha256 "${{ steps.sha.outputs.arm_sha }}"
              else
                url "${{ steps.release.outputs.amd_url }}"
                sha256 "${{ steps.sha.outputs.amd_sha }}"
              end
            end

            def install
              bin.install "${BINARY_NAME}"
            end

            test do
              system "#{bin}/${BINARY_NAME}", "--help"
            end
          end
          RUBY

      - name: Commit and push
        working-directory: tap
        run: |
          set -euo pipefail
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add "${FORMULA_PATH}"
            git commit -m "Update 55h formula to v${{ steps.release.outputs.version }}"
            git push
          else
            echo "No changes to commit"
          fi
